name: CI/CD - Arka Microservices

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com

jobs:
  # ===================== CHECKSTYLE & QUALITY =====================
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven
      
      - name: Run Checkstyle
        run: |
          for service in inventory-service order-service cart-service catalog-service \
                         category-maintainer provider-service shipping-service \
                         notification-service auth-service review-service \
                         catalog-bff-web catalog-bff-mobile eureka-server gateway; do
            if [ -f "$service/pom.xml" ]; then
              echo "Running checkstyle for $service"
              mvn -B -f $service/pom.xml checkstyle:check || echo "Checkstyle warnings in $service"
            fi
          done

  # ===================== BUILD & TEST =====================
  build-and-test:
    runs-on: ubuntu-latest
    needs: code-quality
    strategy:
      matrix:
        service:
          - eureka-server
          - gateway
          - inventory-service
          - order-service
          - cart-service
          - catalog-service
          - category-maintainer
          - provider-service
          - shipping-service
          - notification-service
          - auth-service
          - review-service
          - catalog-bff-web
          - catalog-bff-mobile
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven
      
      - name: Build ${{ matrix.service }}
        run: |
          cd ${{ matrix.service }}
          mvn -B clean package -DskipTests
      
      - name: Run Tests for ${{ matrix.service }}
        run: |
          cd ${{ matrix.service }}
          mvn -B test
      
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.service }}
          path: ${{ matrix.service }}/target/surefire-reports/
          retention-days: 7

  # ===================== BUILD & PUSH DOCKER IMAGES =====================
  build-and-push:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    strategy:
      matrix:
        service:
          - eureka-server
          - gateway
          - inventory-service
          - order-service
          - cart-service
          - catalog-service
          - category-maintainer
          - provider-service
          - shipping-service
          - notification-service
          - auth-service
          - review-service
          - catalog-bff-web
          - catalog-bff-mobile
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build Docker image
        run: |
          cd ${{ matrix.service }}
          docker build -t arka-${{ matrix.service }}:latest \
                       -t ${{ env.ECR_REGISTRY }}/arka-${{ matrix.service }}:latest \
                       -t ${{ env.ECR_REGISTRY }}/arka-${{ matrix.service }}:${{ github.sha }} .
      
      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: arka-${{ matrix.service }}:latest
          format: 'sarif'
          output: 'trivy-results-${{ matrix.service }}.sarif'
      
      - name: Push image to ECR
        run: |
          docker push ${{ env.ECR_REGISTRY }}/arka-${{ matrix.service }}:latest
          docker push ${{ env.ECR_REGISTRY }}/arka-${{ matrix.service }}:${{ github.sha }}
      
      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.service }}.sarif'

  # ===================== DEPLOY TO EC2 =====================
  deploy-ec2:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get EC2 instance IP
        id: ec2-ip
        run: |
          EC2_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=arka-app-ec2" "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text \
            --region ${{ env.AWS_REGION }})
          echo "ip=$EC2_IP" >> $GITHUB_OUTPUT
      
      - name: Deploy to EC2
        env:
          EC2_IP: ${{ steps.ec2-ip.outputs.ip }}
          PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
          
          # Copy docker-compose file to EC2
          scp -o StrictHostKeyChecking=no -i private_key.pem docker-compose.yml ec2-user@$EC2_IP:/home/ec2-user/
          
          # SSH and deploy
          ssh -o StrictHostKeyChecking=no -i private_key.pem ec2-user@$EC2_IP << 'ENDSSH'
            # Login to ECR
            aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
            
            # Pull latest images
            docker-compose pull
            
            # Restart services
            docker-compose down
            docker-compose up -d
            
            # Clean up old images
            docker image prune -af
          ENDSSH
          
          rm -f private_key.pem

  # ===================== LAMBDA DEPLOYMENT =====================
  deploy-lambda:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Lambda dependencies
        run: |
          cd lambda/abandoned-cart-checker
          npm install --production
          cd ../..
      
      - name: Package Lambda functions
        run: |
          cd lambda
          zip -r abandoned-cart-checker.zip abandoned-cart-checker/
          zip -r shipping-pickup.zip shipping-pickup/
          zip -r shipping-delivery.zip shipping-delivery/
          zip -r shipping-express.zip shipping-express/
      
      - name: Deploy Lambda functions
        run: |
          aws lambda update-function-code \
            --function-name arka-abandoned-cart-checker \
            --zip-file fileb://lambda/abandoned-cart-checker.zip \
            --region ${{ env.AWS_REGION }} || echo "Lambda function not found, skipping"
          
          aws lambda update-function-code \
            --function-name arka-shipping-pickup \
            --zip-file fileb://lambda/shipping-pickup.zip \
            --region ${{ env.AWS_REGION }} || echo "Lambda function not found, skipping"
          
          aws lambda update-function-code \
            --function-name arka-shipping-delivery \
            --zip-file fileb://lambda/shipping-delivery.zip \
            --region ${{ env.AWS_REGION }} || echo "Lambda function not found, skipping"
          
          aws lambda update-function-code \
            --function-name arka-shipping-express \
            --zip-file fileb://lambda/shipping-express.zip \
            --region ${{ env.AWS_REGION }} || echo "Lambda function not found, skipping"

  # ===================== SMOKE TESTS =====================
  smoke-tests:
    runs-on: ubuntu-latest
    needs: deploy-ec2
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get EC2 Public DNS
        id: ec2
        run: |
          EC2_DNS=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=arka-app-ec2" "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].PublicDnsName' \
            --output text \
            --region ${{ env.AWS_REGION }})
          echo "dns=$EC2_DNS" >> $GITHUB_OUTPUT
      
      - name: Health check Gateway
        run: |
          echo "Testing gateway at http://${{ steps.ec2.outputs.dns }}:8080"
          for i in {1..30}; do
            if curl -f http://${{ steps.ec2.outputs.dns }}:8080/actuator/health; then
              echo "Gateway is healthy"
              exit 0
            fi
            echo "Waiting for gateway... ($i/30)"
            sleep 10
          done
          echo "Gateway health check failed"
          exit 1
      
      - name: Test critical endpoints
        run: |
          BASE_URL="http://${{ steps.ec2.outputs.dns }}:8080"
          
          # Test inventory service
          curl -f $BASE_URL/api/products || echo "Inventory service check failed"
          
          # Test catalog service
          curl -f $BASE_URL/api/catalog || echo "Catalog service check failed"
          
          # Test auth service
          curl -f -X POST $BASE_URL/auth/validate -H "Authorization: Bearer test" || echo "Auth check ok (expected 401)"

  # ===================== NOTIFICATION =====================
  notify:
    runs-on: ubuntu-latest
    needs: [deploy-ec2, deploy-lambda, smoke-tests]
    if: always()
    
    steps:
      - name: Notify deployment status
        run: |
          if [ "${{ needs.smoke-tests.result }}" == "success" ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed or smoke tests failed"
            exit 1
          fi
